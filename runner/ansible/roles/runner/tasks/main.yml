- name: Copy setup script to host
  copy: 
    src: setup/setup.sh
    dest: /tmp/setup.sh
    mode: '0755'

- name: Copy dockerfile to host
  copy: 
    src: ../docker/runner.Dockerfile
    dest: /tmp/runner.Dockerfile
    mode: '0755'

- name: Build docker image
  community.docker.docker_image:
    build:
      path: /tmp/
    name: vesuvio-runner
    source: build

- name: Deploy dockerized github runner
  community.docker.docker_container:
    name: "{{ runner_name }}"
    image: vesuvio-runner
    detach: yes
    init: yes
    network_mode: host
    recreate: yes
    pull: no
    shm_size: 512M
    volumes:
      - /tmp/setup.sh:/home/setup.sh
    command: /home/setup.sh

- name: Remove setup script
  ansible.builtin.file:
    path: /tmp/setup.sh
    state: absent

- name: Remove dockerfile
  ansible.builtin.file:
    path: /tmp/runner.Dockerfile
    state: absent
  